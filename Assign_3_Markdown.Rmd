---
name: "Sirish Pulijala"
title: "Assignment3"
output: html_document
---

# Data Reading
```{r Data Reading}

library(tidyverse)
library(jsonlite)
library(lubridate)

data<- read_json("https://data.cityofchicago.org/resource/ijzp-q8t2.json?primary_type=THEFT&$limit=30000", simplifyVector = TRUE) 
```

# Question 1.1:
```{r Question 1.1}
thefts<- tibble()
for(i in c(2016:2019)){
  url<- paste0("https://data.cityofchicago.org/resource/ijzp-q8t2.json?primary_type=THEFT&$limit=40000&year=",i, collapse = " ")
  theft_data<-read_json(url,simplifyVector = TRUE)
  theft_data[22]<- NULL
  thefts <- bind_rows(thefts,theft_data)
}
```

# Question 1.2:
```{r Question 1.2}

thefts1<- thefts%>%
  mutate(dates=ymd_hms(date))%>%
  mutate(year=year(dates))%>%
  mutate(month=month(dates))%>%
  mutate(day=day(dates))%>%
  mutate(hour=hour(dates))

thefts1 <- thefts1 %>%
  drop_na(longitude,latitude)

```

# Question 1.3:

```{r Question 1.3}

thefts1 <- thefts1%>%
  mutate(category=case_when(
    description == "$500 AND UNDER" ~ "petty",
    description == "POCKET-PICKING" ~ "petty",
    description == "PURSE-SNATCHING" ~ "petty",
    TRUE ~ "grand"
    ))

```

# Question 2.1

```{r Question 2.1}
library(sf)
thefts1 <- st_as_sf(thefts1,
                   coords = c("longitude", "latitude"),
                   crs = 4326,
                   remove = FALSE)
```

# Question 2.2

```{r Question 2.2}

thefts_fil <- thefts1%>%
  filter(month == month(now())-2| month == month(now())-1)

thefts_fil_sample <- thefts_fil%>%
  sample_frac(0.1)

library(ggplot2)

ggplot() +
  geom_sf( 
    data = thefts_fil_sample , 
    aes(color= category)) +
  theme_void() +
  labs(
    title = "Thefts in Chicago (Previous 2 Months)",
    caption = "Source: City of Chicago Data Portal"
  ) +
  scale_colour_manual (
    values = c("petty" = "blue", "grand" = "red"),
    name = "Theft Category"
  )

```

# Question 2.3:

```{r Question 2.3, message=FALSE, include=TRUE, results='hide'}

library(tidycensus)

census_data<-load_variables(2016,"acs5")
cook_county<- get_acs(
  geography = "tract",
  variables = "B01003_001",
  state = "IL",
  county= "Cook",
  geometry = TRUE
)

cook_county<-st_transform(cook_county,4326)
thefts_merged<-st_join(
  thefts1,
  cook_county,
  join=st_within
)

```

# Question 2.4:

``` {r Question 2.4, message=FALSE, include=TRUE, results="hide"}

thefts_merged$geometry <- NULL
thefts_agg <- thefts_merged %>%
  group_by(NAME, year,GEOID)%>%
  summarise(avg_thefts = n())

theft_joined <- cook_county%>%
  left_join(thefts_agg, by = "GEOID")%>%
  drop_na()%>%
  mutate(thefts_pc = avg_thefts / estimate)

library(ggplot2)
library(sf)
ggplot()+
  geom_sf(
    data = theft_joined,
    aes(fill = thefts_pc), color =NA
  ) +
  theme_void()+
  labs(
    title = "Thefts in Chicago (2016-2019)",
    caption = "Source: City of Chicago Data Portal"
  )+
  scale_fill_distiller (
    name = "Avg Thefts Per Capita Per Year",
    palette = "Spectral"
  )
```

**Why do you think thefts per capita is higher in the Loop and northwest side?
Answer: Since there is more population in the loop & Northwest side and a lot of tourists visit the area, a lot of petty crimes like pick-pocketing tend to occur there. A lot of crimes could also be reported in that areas when compared to others.

**What changes could we make to the map to further clarify the spatial distribution of thefts?
Answer: We can add petty vs grand data to know further information about the thefts.


# Section 3:

``` {r Section 3, message=FALSE, include=TRUE, results="hide"}

cook_data<-get_acs(
  geography = "tract",
  state="IL",
  county = "Cook",
  variables = c(medium_income="B06011_001", white="B02001_002", total_pop="B01003_001", bachelors="B06009_005", below_poverty="B17020_002"),
  year = 2016,
  geometry = TRUE
)
cook_data <-cook_data%>%
  select(-moe)%>%
  spread(variable,estimate)

cook_data<- cook_data %>%
  mutate(percent_white= (white/total_pop)*100) %>%
  mutate(percent_bachelors= (bachelors/total_pop)*100) %>%
  mutate(percent_below_poverty= (below_poverty/total_pop)*100)
  
cook_data <- st_transform(cook_data, 4326)

cook_data <- st_join(
  cook_data,
  theft_joined,
  join = st_within)
  
library(stargazer)

fit<-lm(thefts_pc~ medium_income +percent_white + percent_bachelors+ percent_below_poverty, data= cook_data)
stargazer(fit,type= 'text')

```

# 3.1:

Do you need to include weights in your regression? Fixed effects? Interaction terms? What should we do with missing values? Does our regression specification make sense?

Answer: Yes we need to include weights in our regressions because different variables effect the dependent variable differently or unevenly.We also need to include fixed effect and interaction terms as certain variables are dependent on each other. Take a larger smaple size to solve the problem of missing values. 


# 3.2:
Do you think the coefficients here are reasonable? Which one most influences the number of thefts?

Answer: The coefficients are not exactly reasonable, according to the table percentage of bachelors is influencing the number of thefts.

# 3.3:
Are there variables that you think should be included? Can this regression be interpreted as causal?

Answer: We can include more variables like theft reports, criminal records,etc. It is not exactly causal.
